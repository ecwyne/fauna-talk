import { themes, Image, Split } from 'mdx-deck';
import Highlighter from 'react-syntax-highlighter';
import prismStyle from 'react-syntax-highlighter/dist/esm/styles/prism/vs-dark';
import { CodeSurfer } from 'code-surfer';
import { vsDark } from '@code-surfer/themes';

export const theme = {
    ...themes.default,
    components: {
        pre: themes.prism.components.pre,
        code: props => {
            return themes.prism.components.code({
                ...props,
                style: prismStyle,
            });
        },
    },
};

import avatar from './images/avatar.jpeg';

# :wave: Hello World

<img src={avatar} />
<br />
<div>Eric Wyne</div>
<div>@ecwyne</div>
<img src="https://www.commissionbuddies.com/wp-content/uploads/2018/04/CB_Logos_FINAL_white_30px.png" />

<br />

---

# Company Backgorund

-   :date: Founded 2017
-   :book: Origin Story
-   :credit_card: Processing Referral Network

https://bit.ly/commbuds-nextjs

---

# Technical Requirements

-   :zap: Rapid Development
-   :woman_in_lotus_position: Flexible Architecture
-   :chart_with_upwards_trend: Scalable
-   :lock: Secure
-   :heavy_dollar_sign: Transactional

---

# Meteor.js

-   :white_check_mark: Rapid Development
-   :white_check_mark: Flexible Architecture
-   :x: Scalable
-   :white_check_mark: Secure
-   :x: Transactional

---

# ~~Meteor.js~~

-   :white_check_mark: Rapid Development
-   :white_check_mark: Flexible Architecture
-   :x: Scalable
-   :white_check_mark: Secure
-   :x: Transactional

---

# Gatsby/Netlify Functions

-   :warning: Rapid Development
-   :warning: Flexible Architecture
-   :white_check_mark: Scalable
-   :grey_question: Secure
-   :grey_question: Transactional

---

# ~~Gatsby/Netlify Functions~~

-   :warning: Rapid Development
-   :warning: Flexible Architecture
-   :white_check_mark: Scalable
-   :grey_question: Secure
-   :grey_question: Transactional

---

# Next.js + Now.sh (circa 2017)

-   :white_check_mark: Rapid Development
-   :white_check_mark: Flexible Architecture
-   :white_check_mark: Scalable
-   :grey_question: Secure
-   :grey_question: Transactional

---

# :tada: Next.js (v9.0) :tada:

-   :rocket: Rapid Development
-   :white_check_mark: Flexible Architecture
-   :white_check_mark: Scalable
-   :grey_question: Secure
-   :grey_question: Transactional

---

# What about data?

-   :grey_question: Secure
-   :grey_question: Transactional

---

import tree from './images/tree.png';

<div style={{display: 'flex', justifyContent: 'center', alignItems: 'center'}}>


<div>
    <img src={tree} style={{ width: '100%', height: '100%' }} />
</div>

<div>


# An example...

Accruing commissions

-   Programatically climb account hierarchy
-   Data consistency is vital
-   ACID compliant transactions

</div>


</div>


---

# MongoDB

-   :white_check_mark: Rapid Development
-   :white_check_mark: Flexible Architecture
-   :warning: Scalable
-   :warning: Secure
-   :x: Transactional

---

# DynamoDB

-   :x: Rapid Development
-   :warning: Flexible Architecture
-   :white_check_mark: Scalable
-   :warning: Secure
-   :x: Transactional (circa 2017)

---

# Firebase

-   :white_check_mark: Rapid Development
-   :white_check_mark: Flexible Architecture
-   :white_check_mark: Scalable
-   :white_check_mark: Secure
-   :x: Transactional

---

# FaunaDB

-   :white_check_mark: Rapid Development
-   :white_check_mark: Flexible Architecture
-   :white_check_mark: Scalable
-   :white_check_mark: Secure
-   :white_check_mark: Transactional

---

# :tada: FaunaDB :tada:

-   :white_check_mark: Rapid Development
-   :white_check_mark: Flexible Architecture
-   :white_check_mark: Scalable
-   :white_check_mark: Secure
-   :white_check_mark: Transactional

---

# Additionally...

-   :cloud: Built for serverless
-   :clock2: Built-in temporality
-   :earth_americas: Hands-free geo-distribution
-   :atom_symbol: GraphQL API
-   :muscle: Powerful Query Language (FQL)
-   :zap: Real-time streaming (in beta)

---

# Next.js + FaunaDB :rocket: :rocket: :rocket:

---

### FQL vs GraphQL

<iframe
    width="560"
    height="315"
    src="https://www.youtube.com/embed/KlUPiQaTp0I"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen
></iframe>

---

import signup from './images/signup.png';

#### Visit https://dashboard.fauna.com

<Image src={signup} style={{ width: '90%', backgroundSize: 'contain' }}></Image>

---

import newdb from './images/newdb.png';

#### Create a database

<Image src={newdb} style={{ height: '50%', backgroundSize: 'contain' }}></Image>

---

import dbhome from './images/dbhome.png';

<Image src={dbhome} style={{ width: '90%', backgroundSize: 'contain' }}></Image>

---

import newcollection from './images/newcollection.png';

#### Create a collection

<Image
    src={newcollection}
    style={{ height: '75%', width: '90%', backgroundSize: 'contain' }}
></Image>

---

import newdocument from './images/newdocument.png';

#### Create a user document

<Image
    src={newdocument}
    style={{ height: '75%', width: '90%', backgroundSize: 'contain' }}
></Image>

---

import collectionlist from './images/collectionlist.png';

<Image
    src={collectionlist}
    style={{ height: '75%', width: '90%', backgroundSize: 'contain' }}
></Image>

---

<CodeSurfer theme={vsDark}>


```ts title="FQL"
import { query as q } from 'faunadb';

const data = { handle: 'ecwyne' };

const usersCollection = q.Collection('users');
const createUserQuery = q.Create(usersCollection, { data });
```

</CodeSurfer>


---

import drivers from './images/drivers.png';

<Image
    src={drivers}
    style={{ height: '50%', backgroundSize: 'contain' }}
></Image>

---

### [https://docs.fauna.com/fauna/current/api/fql/cheat_sheet](https://docs.fauna.com/fauna/current/api/fql/cheat_sheet)

import cheatsheet from './images/cheatsheet.png';

<Image
    src={cheatsheet}
    style={{ width: '90%', backgroundSize: 'contain' }}
></Image>

---

import updatepassword from './images/updatepassword.png';

<Image
    src={updatepassword}
    style={{ height: '75%', width: '90%', backgroundSize: 'contain' }}
></Image>

---

import newindex from './images/newindex.png';

#### Create an index

<Image
    src={newindex}
    style={{ height: '75%', width: '90%', backgroundSize: 'contain' }}
></Image>

---

## Let's jump into some code!

---

<CodeSurfer theme={vsDark}>


```ts title="FaunaDB Client"
import { Client } from 'faunadb';

const client = new Client({ secret: '...' });
await client.query(query).then(...)
```

</CodeSurfer>


---

import createserverkey from './images/createserverkey.png';

<Image
    src={createserverkey}
    style={{ height: '75%', width: '90%', backgroundSize: 'contain' }}
></Image>

---

import serverkey from './images/serverkey.png';

<Image
    src={serverkey}
    style={{ height: '75%', width: '90%', backgroundSize: 'contain' }}
></Image>

---

# First the Server

---

<CodeSurfer theme={vsDark}>


```ts 3:5 title="pages/api/login.ts" subtitle="Instantiate Fauna Client"
import { Client, query as q } from 'faunadb';

const client = new Client({
    secret: 'fnAD4lN6LsACDZCBTVS5LkxWHMSpSTAuDLTImMe7',
});

const handler = async (req, res) => {
    const { handle, password } = req.body;
    // Match user by handle
    const matchedUser = q.Match(q.Index('userByHandle'), handle);
    // Use password to get user secret
    client
        .query(q.Login(matchedUser, { password }))
        .then(({ secret }) => res.send(secret));
};

export default handler;
```

```ts 8 title="pages/api/login.ts" subtitle="Destructure handle and password"
import { Client, query as q } from 'faunadb';

const client = new Client({
    secret: 'fnAD4lN6LsACDZCBTVS5LkxWHMSpSTAuDLTImMe7',
});

const handler = async (req, res) => {
    const { handle, password } = req.body;
    // Match user by handle
    const matchedUser = q.Match(q.Index('userByHandle'), handle);
    // Use password to get user secret
    client
        .query(q.Login(matchedUser, { password }))
        .then(({ secret }) => res.send(secret));
};

export default handler;
```

```ts 9:10 title="pages/api/login.ts"  subtitle="Match user by handle"
import { Client, query as q } from 'faunadb';

const client = new Client({
    secret: 'fnAD4lN6LsACDZCBTVS5LkxWHMSpSTAuDLTImMe7',
});

const handler = async (req, res) => {
    const { handle, password } = req.body;
    // Match user by handle
    const matchedUser = q.Match(q.Index('userByHandle'), handle);
    // Use password to get user secret
    client
        .query(q.Login(matchedUser, { password }))
        .then(({ secret }) => res.send(secret));
};

export default handler;
```

```ts 11:14 title="pages/api/login.ts" subtitle="Use password to get user secret"
import { Client, query as q } from 'faunadb';

const client = new Client({
    secret: 'fnAD4lN6LsACDZCBTVS5LkxWHMSpSTAuDLTImMe7',
});

const handler = async (req, res) => {
    const { handle, password } = req.body;
    // Match user by handle
    const matchedUser = q.Match(q.Index('userByHandle'), handle);
    // Use password to get user secret
    client
        .query(q.Login(matchedUser, { password }))
        .then(({ secret }) => res.send(secret));
};

export default handler;
```

</CodeSurfer>


---

# Now to the client

---

<CodeSurfer theme={vsDark}>


```ts showNumbers title="fauna-hooks.ts"
import { Client, query as q } from 'faunadb';
import useSwr from 'swr';
import create from 'zustand';

const useStore = create(() => ({ secret: '' }));

export const login = async (handle, password) => {
    const secret = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ handle, password }),
    }).then(r => r.text());
    useStore.setState({ secret });
};

export function useQuery(query) {
    const secret = useStore(state => state.secret);
    const key = secret ? [secret, JSON.stringify(query)] : null;
    return useSwr(key, secret => new Client({ secret }).query(query));
}

export const useIdentity = () => useQuery(q.Get(q.Identity()));

// Usage
// const { data, error, isValidating } = useIdentity();
```

```ts 24:25 title="fauna-hooks.ts" subtitle="Here's the goal"
import { Client, query as q } from 'faunadb';
import useSwr from 'swr';
import create from 'zustand';

const useStore = create(() => ({ secret: '' }));

export const login = async (handle, password) => {
    const secret = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ handle, password }),
    }).then(r => r.text());
    useStore.setState({ secret });
};

export function useQuery(query) {
    const secret = useStore(state => state.secret);
    const key = secret ? [secret, JSON.stringify(query)] : null;
    return useSwr(key, secret => new Client({ secret }).query(query));
}

export const useIdentity = () => useQuery(q.Get(q.Identity()));

// Usage
// const { data, error, isValidating } = useIdentity();
```

```ts 1:3 title="fauna-hooks.ts" subtitle="Using these technologies"
import { Client, query as q } from 'faunadb';
import useSwr from 'swr';
import create from 'zustand';

const useStore = create(() => ({ secret: '' }));

export const login = async (handle, password) => {
    const secret = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ handle, password }),
    }).then(r => r.text());
    useStore.setState({ secret });
};

export function useQuery(query) {
    const secret = useStore(state => state.secret);
    const key = secret ? [secret, JSON.stringify(query)] : null;
    return useSwr(key, secret => new Client({ secret }).query(query));
}

export const useIdentity = () => useQuery(q.Get(q.Identity()));

// Usage
// const { data, error, isValidating } = useIdentity();
```

```ts 5 title="fauna-hooks.ts" subtitle="Create zustand store"
import { Client, query as q } from 'faunadb';
import useSwr from 'swr';
import create from 'zustand';

const useStore = create(() => ({ secret: '' }));

export const login = async (handle, password) => {
    const secret = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ handle, password }),
    }).then(r => r.text());
    useStore.setState({ secret });
};

export function useQuery(query) {
    const secret = useStore(state => state.secret);
    const key = secret ? [secret, JSON.stringify(query)] : null;
    return useSwr(key, secret => new Client({ secret }).query(query));
}

export const useIdentity = () => useQuery(q.Get(q.Identity()));

// Usage
// const { data, error, isValidating } = useIdentity();
```

```ts 7,8,12 title="fauna-hooks.ts" subtitle="Login from anywhere"
import { Client, query as q } from 'faunadb';
import useSwr from 'swr';
import create from 'zustand';

const useStore = create(() => ({ secret: '' }));

export const login = async (handle, password) => {
    const secret = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ handle, password }),
    }).then(r => r.text());
    useStore.setState({ secret });
};

export function useQuery(query) {
    const secret = useStore(state => state.secret);
    const key = secret ? [secret, JSON.stringify(query)] : null;
    return useSwr(key, secret => new Client({ secret }).query(query));
}

export const useIdentity = () => useQuery(q.Get(q.Identity()));

// Usage
// const { data, error, isValidating } = useIdentity();
```

```ts 7,13 title="fauna-hooks.ts" subtitle="Update store with secret"
import { Client, query as q } from 'faunadb';
import useSwr from 'swr';
import create from 'zustand';

const useStore = create(() => ({ secret: '' }));

export const login = async (handle, password) => {
    const secret = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ handle, password }),
    }).then(r => r.text());
    useStore.setState({ secret });
};

export function useQuery(query) {
    const secret = useStore(state => state.secret);
    const key = secret ? [secret, JSON.stringify(query)] : null;
    return useSwr(key, secret => new Client({ secret }).query(query));
}

export const useIdentity = () => useQuery(q.Get(q.Identity()));

// Usage
// const { data, error, isValidating } = useIdentity();
```

```ts 16,17 title="fauna-hooks.ts" subtitle="Read secret from store"
import { Client, query as q } from 'faunadb';
import useSwr from 'swr';
import create from 'zustand';

const useStore = create(() => ({ secret: '' }));

export const login = async (handle, password) => {
    const secret = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ handle, password }),
    }).then(r => r.text());
    useStore.setState({ secret });
};

export function useQuery(query) {
    const secret = useStore(state => state.secret);
    const key = secret ? [secret, JSON.stringify(query)] : null;
    return useSwr(key, secret => new Client({ secret }).query(query));
}

export const useIdentity = () => useQuery(q.Get(q.Identity()));

// Usage
// const { data, error, isValidating } = useIdentity();
```

```ts 16,18 title="fauna-hooks.ts" subtitle="Build SWR key"
import { Client, query as q } from 'faunadb';
import useSwr from 'swr';
import create from 'zustand';

const useStore = create(() => ({ secret: '' }));

export const login = async (handle, password) => {
    const secret = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ handle, password }),
    }).then(r => r.text());
    useStore.setState({ secret });
};

export function useQuery(query) {
    const secret = useStore(state => state.secret);
    const key = secret ? [secret, JSON.stringify(query)] : null;
    return useSwr(key, secret => new Client({ secret }).query(query));
}

export const useIdentity = () => useQuery(q.Get(q.Identity()));

// Usage
// const { data, error, isValidating } = useIdentity();
```

```ts 16,19 title="fauna-hooks.ts" subtitle="Call useSwr with fetcher"
import { Client, query as q } from 'faunadb';
import useSwr from 'swr';
import create from 'zustand';

const useStore = create(() => ({ secret: '' }));

export const login = async (handle, password) => {
    const secret = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ handle, password }),
    }).then(r => r.text());
    useStore.setState({ secret });
};

export function useQuery(query) {
    const secret = useStore(state => state.secret);
    const key = secret ? [secret, JSON.stringify(query)] : null;
    return useSwr(key, secret => new Client({ secret }).query(query));
}

export const useIdentity = () => useQuery(q.Get(q.Identity()));

// Usage
// const { data, error, isValidating } = useIdentity();
```

```ts 22 title="fauna-hooks.ts" subtitle="Putting it all together"
import { Client, query as q } from 'faunadb';
import useSwr from 'swr';
import create from 'zustand';

const useStore = create(() => ({ secret: '' }));

export const login = async (handle, password) => {
    const secret = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ handle, password }),
    }).then(r => r.text());
    useStore.setState({ secret });
};

export function useQuery(query) {
    const secret = useStore(state => state.secret);
    const key = secret ? [secret, JSON.stringify(query)] : null;
    return useSwr(key, secret => new Client({ secret }).query(query));
}

export const useIdentity = () => useQuery(q.Get(q.Identity()));

// Usage
// const { data, error, isValidating } = useIdentity();
```

</CodeSurfer>


---

# Thanks! :wave:

Fauna Dashboard: https://dashboard.fauna.com

Fauna Docs: https://docs.fauna.com

Commission Buddies: https://commissionbuddies.com

Join Commission Buddies: https://bit.ly/commbuds-nextjs

Slides: https://nextjs-conf-fauna.vercel.app
